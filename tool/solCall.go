package main

import (
	"context"
	"encoding/hex"
	"errors"
	"fmt"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"log"
	"math/big"
	"math/rand"
)

var myinputs = []string{
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000013100000000000000000000000000000000000000000000000000000000000000",  //0:  1
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000013200000000000000000000000000000000000000000000000000000000000000",  //1:  2
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000013300000000000000000000000000000000000000000000000000000000000000",  //2:  3
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000013400000000000000000000000000000000000000000000000000000000000000",  //3:  4
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000013500000000000000000000000000000000000000000000000000000000000000",  //4:  5
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000013600000000000000000000000000000000000000000000000000000000000000",  //5:  6
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000013700000000000000000000000000000000000000000000000000000000000000",  //6:  7
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000013800000000000000000000000000000000000000000000000000000000000000",  //7:  8
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000013900000000000000000000000000000000000000000000000000000000000000",  //8:  9
	"a41368620000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000231300000000000000000000000000000000000 00000000000000000000000000", //9: 10
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000033130300000000000000000000000000000000000000000000000000000000000",  //10: 100
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000016100000000000000000000000000000000000000000000000000000000000000",  //11: a
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000016200000000000000000000000000000000000000000000000000000000000000",  //12: b
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000016300000000000000000000000000000000000000000000000000000000000000",  //13: c
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000016400000000000000000000000000000000000000000000000000000000000000",  //14: d
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000016500000000000000000000000000000000000000000000000000000000000000",  //15: e
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000016600000000000000000000000000000000000000000000000000000000000000",  //16: f
	"a4136862000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000016700000000000000000000000000000000000000000000000000000000000000",  //17: g
}

func sendSolidityTx(privKey string, client *Client, nonce uint64)error {

	pri, err := crypto.HexToECDSA(privKey)
	if err != nil {
		log.Fatal("err", err)
		return errors.New("交易出错")
	}
	//from := crypto.PubkeyToAddress(pri.PublicKey)
	to := common.HexToAddress(contract)
	//fmt.Printf("to:%s from:%s\n", to.String(), from.String())

	amount := big.NewInt(0)
	gasLimit := uint64(43766)
	//gasLimit := uint64(4712388)
	gasPrice := big.NewInt(240000000000) //todo 此处很重要，不可以太低，可能会报underprice错误，增大该值就没有问题了
	//fmt.Println("nonce", nonce)
	r := rand.Intn(len(myinputs))
	input := myinputs[r]
	data := common.Hex2Bytes(input)
	tx := types.NewTransaction(nonce, to, amount, gasLimit, gasPrice, data)
	signedTx, _ := types.SignTx(tx, types.NewEIP155Signer(big.NewInt(739)), pri)
	if _, err := client.SendRawTransaction(context.TODO(), signedTx); err != nil {
		log.Println("send raw transaction error", err.Error())
		return err

	} else {
		//log.Printf("Transaction hash: %s\n", txHash.String())

	}
	return nil
}

func DeploySol(client *Client) string {

	path := "6060604052341561000f57600080fd5b6040516104c73803806104c783398101604052808051820191905050336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508060019080519060200190610081929190610088565b505061012d565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100c957805160ff19168380011785556100f7565b828001600101855582156100f7579182015b828111156100f65782518255916020019190600101906100db565b5b5090506101049190610108565b5090565b61012a91905b8082111561012657600081600090555060010161010e565b5090565b90565b61038b8061013c6000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806341c0e1b514610053578063a413686214610068578063cfae3217146100c557600080fd5b341561005e57600080fd5b610066610153565b005b341561007357600080fd5b6100c3600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506101e4565b005b34156100d057600080fd5b6100d86101fe565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156101185780820151818401526020810190506100fd565b50505050905090810190601f1680156101455780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156101e2576000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b565b80600190805190602001906101fa9291906102a6565b5050565b610206610326565b60018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561029c5780601f106102715761010080835404028352916020019161029c565b820191906000526020600020905b81548152906001019060200180831161027f57829003601f168201915b5050505050905090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106102e757805160ff1916838001178555610315565b82800160010185558215610315579182015b828111156103145782518255916020019190600101906102f9565b5b509050610322919061033a565b5090565b602060405190810160405280600081525090565b61035c91905b80821115610358576000816000905550600101610340565b5090565b905600a165627a7a723058201ef87c90fca101864bb70ef1ac60d5510f2af93c1374d2c7c4f6ee8d40d9e4ba002900000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000"

	//sol
	code, err := hex.DecodeString(path)

	if err != nil {
		log.Fatal("read fail", err)
		return ""
	}

	//type Meta map[string][]byte

	//meta := Meta{"name": []byte("tonysu"), "version": []byte("1.2"), "desc": []byte("tony's new contract"), "jwt": []byte("eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJhayI6IjAzYTY0M2NmOGIwMmI1MDA1YjRlNDhhY2RjOTRhOGY2OTMzNTVhNGViNTEyOTJkNTUwOGI5N2YzZTYxNTllM2RlNiIsImwiOjYwMDAwMDAwMDAwLCJuIjoiZWVmZmZlZnJlcmVkZmZkc3V1ZjJycmZkc21mbGpsanJyIiwiciI6ImQiLCJzIjoxNzM0NzgsInNrIjoiMDI1OTVkNTUzNjk3MzA1Yzc2NzBkZmQ5MjYyOGU1ZmY2ODA4MDMzNTI2NWVkZjgwNGFlYTRlNmU4ZGY1MTEyNDY0In0.NZAOqpZ65LqDP5x0OS6ECGdSUPN2zlMGcsGPf4Ibij7_aQEOECC5HmoX-P7M0rPhjI_ssAntMdZJJhKs1jKC7w")}
	//metaByte, _ := json.Marshal(meta)
	//metaStr := hex.EncodeToString(metaByte)
	//strcode:=flagNo0x+"_"+hex.EncodeToString(code)+"_"+metaStr
	pri, err := crypto.HexToECDSA(privKeys)
	if err != nil {
		log.Fatal("err", err)
		return ""
	}
	from := crypto.PubkeyToAddress(pri.PublicKey)
	fmt.Println("from", from.String())
	nonce, _ := client.EthClient.PendingNonceAt(context.TODO(), from)
	if err != nil {
		log.Fatal("err2222", err)
		return ""
	}

	//fmt.Println(time.Now(), "eeeeeeeeeeeeeeee", nonce)

	//msg := ethereum.CallMsg{
	//	From: from,
	//	Data: code, //code =wasm code1 =sol
	//}

	//gas, err := client.EthClient.EstimateGas(context.Background(), msg)
	//if err != nil {
	//	fmt.Println("预估的gas err", err)
	//	return
	//}

	//fmt.Println("预估的gas", gas)
	//for i:=0;i<=5;i++{
	fmt.Println("nonce", nonce)
	tx, err := types.SignTx(
		types.NewContractCreation(
			nonce,
			new(big.Int),
			338689,
			new(big.Int).Mul(big.NewInt(1e9), big.NewInt(18)),
			code),
		types.NewEIP155Signer(big.NewInt(739)),
		pri,
	)
	if err != nil {
		log.Fatal("tx err", err)
	}

	hashes, err := client.SendRawTransaction(context.Background(), tx)
	if err != nil {
		fmt.Println("tx err", err)
	}
	fmt.Println("txHash", hashes.Hex())

	fmt.Println("合约地址", crypto.CreateAddress(from, tx.Nonce()).Hex())

	return crypto.CreateAddress(from, tx.Nonce()).Hex()

}
